; go test -run TransalteAccAggrToSql ./ompp/db
;
; go test -run TransalteAccAggrToSql$ ./ompp/db
; go test -v -run TransalteAccAggrToSql$ ./ompp/db
;
[TransalteAccAggrToSql]
ModelName      = modelOne
ModelDigest    = 
DbPath         = ../../../test/modelOne.sqlite
TableName      = salarySex

Src_1    = OM_SUM(acc1)
Valid_1  = WITH asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT A.run_id, 0 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A

Src_3    = OM_SUM(acc0 - 0.5 * OM_AVG(acc0))
Valid_3  = WITH asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT A.run_id, 0 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value - 0.5 * T2.ex1) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A


; go test -run TranslateTableCalcToSql ./ompp/db
; go test -v -run TranslateTableCalcToSql$ ./ompp/db
;
[TranslateTableCalcToSql]
ModelName      = modelOne
ModelDigest    = 
DbPath         = ../../../test/modelOne.sqlite
TableName      = salarySex

Calculate_1     = expr0 , expr1
CalculateAggr_1 = OM_AVG(acc0) , OM_SUM(acc1)
RunIds_1        = 201,202
Valid_1 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, AVG(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_2     = expr0 , expr1
CalculateAggr_2 = OM_COUNT(acc0) , OM_MIN(acc1) , OM_MAX(acc1)
RunIds_2        = 201,202
Valid_2 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, COUNT(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, MIN(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2402 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, MAX(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_3     = expr0 , expr1
CalculateAggr_3 = OM_VAR(acc0) , OM_SD(acc1)
RunIds_3        = 201,202
Valid_3  = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SQRT(SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 1 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_4     = expr0 , expr1
CalculateAggr_4 = OM_SE(acc0) , OM_CV(acc1)
RunIds_4        = 201,202
Valid_4 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SQRT(SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END / CASE WHEN ABS( COUNT(M1.acc_value) ) > 1.0e-37 THEN COUNT(M1.acc_value) ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, 100 * ( SQRT(SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END ) / CASE WHEN ABS( AVG(M1.acc_value) ) > 1.0e-37 THEN AVG(M1.acc_value) ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 1 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

; no aggregation, no comparison, simple experssion
;
Calculate_11 = expr0 - expr1
RunIds_11    = 201,202,205
Valid_11     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 - B1.src1 AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) WHERE B.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4

Calculate_13 = (expr1 + expr2) / OM_DIV_BY(expr0)
RunIds_13    = 201,202,205
Valid_13     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), cs2 (run_id, dim0, dim1, src2) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 2) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, (B1.src1 + B2.src2) / CASE WHEN ABS(B.src0) > 1.0e-37 THEN B.src0 ELSE NULL END AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) INNER JOIN cs2 B2 ON (B2.run_id = B.run_id AND B2.dim0 = B.dim0 AND B2.dim1 = B.dim1) WHERE B.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4

; no aggregation, comparison
;
Calculate_12 = expr1[variant] + expr0[base]
BaseRunId_12 = 201
RunIds_12    = 202,205
Valid_12     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT V.run_id, 1200 AS calc_id, B.dim0, B.dim1, V.src1 + B.src0 AS calc_value FROM cs0 B INNER JOIN cs1 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

Calculate_14 = (expr1[base] + expr1[variant] + expr0[variant]) / OM_DIV_BY(expr0[base])
BaseRunId_14 = 201
RunIds_14    = 202,205
Valid_14     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT V.run_id, 1200 AS calc_id, B.dim0, B.dim1, (B1.src1 + V1.src1 + V.src0) / CASE WHEN ABS(B.src0) > 1.0e-37 THEN B.src0 ELSE NULL END AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) INNER JOIN cs0 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) INNER JOIN cs1 V1 ON (V1.run_id = B.run_id AND V1.dim0 = B.dim0 AND V1.dim1 = B.dim1) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

Calculate_20 = expr1 , expr1[variant] - expr1[base]
BaseRunId_20 = 201
RunIds_20    = 202,205
Valid_20     = WITH cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202, 205) UNION ALL SELECT V.run_id, 1201 AS calc_id, B.dim0, B.dim1, V.src1 - B.src1 AS calc_value FROM cs1 B INNER JOIN cs1 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4


; go test -run CalculateOutputTable ./ompp/db
; go test -v -run CalculateOutputTable$ ./ompp/db
;
[CalculateOutputTable]
ModelName      = modelOne
ModelDigest    = 
DbPath         = ../../../test/modelOne.sqlite
TableName      = salarySex

Calculate_1     = expr0 , expr1
CalculateAggr_1 = OM_AVG(acc0) , OM_SUM(acc1)
RunIds_1        = 201,202,205
