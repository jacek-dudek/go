; go test -run TransalteAccAggrToSql ./ompp/db
;
; go test -run TransalteAccAggrToSql$ ./ompp/db
; go test -v -run TransalteAccAggrToSql$ ./ompp/db
;
[TransalteAccAggrToSql]
ModelName      = modelOne
ModelDigest    = 
DbPath         = ../../../test/modelOne.sqlite
TableName      = salarySex

Src_1    = OM_SUM(acc1)
Valid_1  = WITH asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT A.run_id, 0 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A

Src_3    = OM_SUM(acc0 - 0.5 * OM_AVG(acc0))
Valid_3  = WITH asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT A.run_id, 0 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value - 0.5 * T2.ex1) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A


; go test -run TranslateTableCalcToSql ./ompp/db
; go test -v -run TranslateTableCalcToSql$ ./ompp/db
;
[TranslateTableCalcToSql]
ModelName      = modelOne
ModelDigest    = 
DbPath         = ../../../test/modelOne.sqlite
TableName      = salarySex

Calculate_1     = expr0 , expr1
CalculateAggr_1 = OM_AVG(acc0) , OM_SUM(acc1)
RunIds_1        = 201,202
Valid_1 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, AVG(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_2     = expr0 , expr1
CalculateAggr_2 = OM_COUNT(acc0) , OM_MIN(acc1) , OM_MAX(acc1)
RunIds_2        = 201,202
Valid_2 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, COUNT(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, MIN(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2402 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, MAX(M1.acc_value) AS calc_value FROM asrc M1 WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_3     = expr0 , expr1
CalculateAggr_3 = OM_VAR(acc0) , OM_SD(acc1)
RunIds_3        = 201,202
Valid_3  = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SQRT(SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 1 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_4     = expr0 , expr1
CalculateAggr_4 = OM_SE(acc0) , OM_CV(acc1)
RunIds_4        = 201,202
Valid_4 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SQRT(SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END / CASE WHEN ABS( COUNT(M1.acc_value) ) > 1.0e-37 THEN COUNT(M1.acc_value) ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, 100 * ( SQRT(SUM(((M1.acc_value) - T2.ex1) * ((M1.acc_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value) - 1 ELSE NULL END ) / CASE WHEN ABS( AVG(M1.acc_value) ) > 1.0e-37 THEN AVG(M1.acc_value) ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value) AS ex1 FROM asrc M2 WHERE M2.acc_id = 1 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

; no aggregation, no comparison, simple experssion
;
Calculate_11 = expr0 - expr1
RunIds_11    = 201,202,205
Valid_11     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 - B1.src1 AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) WHERE B.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4

Calculate_12 = (expr1 + expr2) / OM_DIV_BY(expr0)
RunIds_12    = 201,202,205
Valid_12     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), cs2 (run_id, dim0, dim1, src2) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 2) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, (B1.src1 + B2.src2) / CASE WHEN ABS(B.src0) > 1.0e-37 THEN B.src0 ELSE NULL END AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) INNER JOIN cs2 B2 ON (B2.run_id = B.run_id AND B2.dim0 = B.dim0 AND B2.dim1 = B.dim1) WHERE B.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4

; no aggregation, comparison
;
Calculate_21 = expr1[variant] + expr0[base]
BaseRunId_21 = 201
RunIds_21    = 202,205
Valid_21     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT V.run_id, 1200 AS calc_id, B.dim0, B.dim1, V.src1 + B.src0 AS calc_value FROM cs0 B INNER JOIN cs1 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

Calculate_22 = (expr1[base] + expr1[variant] + expr0[variant]) / OM_DIV_BY(expr0[base])
BaseRunId_22 = 201
RunIds_22    = 202,205
Valid_22     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT V.run_id, 1200 AS calc_id, B.dim0, B.dim1, (B1.src1 + V1.src1 + V.src0) / CASE WHEN ABS(B.src0) > 1.0e-37 THEN B.src0 ELSE NULL END AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) INNER JOIN cs0 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) INNER JOIN cs1 V1 ON (V1.run_id = B.run_id AND V1.dim0 = B.dim0 AND V1.dim1 = B.dim1) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

Calculate_23 = expr1 , expr1[variant] - expr1[base]
BaseRunId_23 = 201
RunIds_23    = 202,205
Valid_23     = WITH cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202, 205) UNION ALL SELECT V.run_id, 1201 AS calc_id, B.dim0, B.dim1, V.src1 - B.src1 AS calc_value FROM cs1 B INNER JOIN cs1 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

; no aggregation, no comparison, simple experssion, using parameters
;
Calculate_31 = expr0 - expr1 + param.StartingSeed
RunIds_31    = 201,202,205
Valid_31     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), par_103 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (201, 202, 205) GROUP BY RP.run_id) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 - B1.src1 + BP103.param_value AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) INNER JOIN par_103 BP103 ON (BP103.run_id = B.run_id) WHERE B.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4

Calculate_32 = (expr1 + expr2 + param.StartingSeed) / OM_DIV_BY(expr0 / (1000 / param.StartingSeed))
RunIds_32    = 201,202,205
Valid_32     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), cs2 (run_id, dim0, dim1, src2) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 2), par_103 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (201, 202, 205) GROUP BY RP.run_id) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, (B1.src1 + B2.src2 + BP103.param_value) / CASE WHEN ABS(B.src0 / (1000 / BP103.param_value)) > 1.0e-37 THEN B.src0 / (1000 / BP103.param_value) ELSE NULL END AS calc_value FROM cs0 B INNER JOIN cs1 B1 ON (B1.run_id = B.run_id AND B1.dim0 = B.dim0 AND B1.dim1 = B.dim1) INNER JOIN cs2 B2 ON (B2.run_id = B.run_id AND B2.dim0 = B.dim0 AND B2.dim1 = B.dim1) INNER JOIN par_103 BP103 ON (BP103.run_id = B.run_id) WHERE B.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4

; no aggregation, comparison, using parameters
;
Calculate_41 = (expr1[variant] + expr0[base]) + (param.StartingSeed[variant] - param.StartingSeed[base])
BaseRunId_41 = 201
RunIds_41    = 202,205
Valid_41     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), pbase_103 (param_base) AS (SELECT AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id = 201), pvar_103 (run_id, param_var) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (202, 205) GROUP BY RP.run_id) SELECT V.run_id, 1200 AS calc_id, B.dim0, B.dim1, (V.src1 + B.src0) + (PV103.param_var - PB103.param_base) AS calc_value FROM cs0 B INNER JOIN cs1 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) INNER JOIN pbase_103 PB103 INNER JOIN pvar_103 PV103 ON (PV103.run_id = V.run_id) WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

Calculate_42 = expr1 + param.StartingSeed , (expr1[variant] - expr1[base]) + param.StartingSeed[base]
BaseRunId_42 = 201
RunIds_42    = 202,205
Valid_42     = WITH cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), par_103 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (201, 202, 205) GROUP BY RP.run_id), pbase_103 (param_base) AS (SELECT AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id = 201) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src1 + BP103.param_value AS calc_value FROM cs1 B INNER JOIN par_103 BP103 ON (BP103.run_id = B.run_id) WHERE B.run_id IN (201, 202, 205) UNION ALL SELECT V.run_id, 1201 AS calc_id, B.dim0, B.dim1, (V.src1 - B.src1) + PB103.param_base AS calc_value FROM cs1 B INNER JOIN cs1 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) INNER JOIN pbase_103 PB103 WHERE B.run_id = 201 AND V.run_id IN (202, 205) ORDER BY 1, 2, 3, 4

; ModelName      = RiskPaths
; ModelDigest    = 
; DbPath         = ../../../test/RiskPaths.sqlite
; TableName      = T04_FertilityRatesByAgeGroup

; RiskPaths no aggregation, no comparison, simple experssion with parameters
;
; Calculate_34 = Expr0 * (param.SimulationCases / param.SimulationSeed)
; RunIds_34    = 102
; Valid_34     = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM T04_FertilityRatesByAgeGroup_v94c1a40e C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 104) WHERE C.expr_id = 0), par_106 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM SimulationCases_p8b4bccb7 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 106) WHERE RP.run_id = 102 GROUP BY RP.run_id), par_107 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM SimulationSeed_p3df984c3 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 107) WHERE RP.run_id = 102 GROUP BY RP.run_id) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 * (BP106.param_value / BP107.param_value) AS calc_value FROM cs0 B INNER JOIN par_106 BP106 ON (BP106.run_id = B.run_id) INNER JOIN par_107 BP107 ON (BP107.run_id = B.run_id) WHERE B.run_id IN (102) ORDER BY 1, 2, 3, 4

; mix of expressions and aggregation, no comparison, using parameters
;
Calculate_51     = expr0 , expr1
CalculateAggr_51 = OM_AVG(acc0) + param.StartingSeed , OM_SUM(acc1 + 100 / param.StartingSeed)
RunIds_51        = 201,202
Valid_51 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)), par_103 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (201, 202) GROUP BY RP.run_id) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 AS calc_value FROM cs1 B WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, AVG(M1.acc_value) + M1P103.param_value AS calc_value FROM asrc M1 INNER JOIN par_103 M1P103 ON (M1P103.run_id = M1.run_id) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value + 100 / M1P103.param_value) AS calc_value FROM asrc M1 INNER JOIN par_103 M1P103 ON (M1P103.run_id = M1.run_id) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

Calculate_52     = expr0 , expr1 + param.StartingSeed
CalculateAggr_52 = OM_SE(acc0 + param.StartingSeed) , OM_CV(acc1 + 100 / param.StartingSeed)
RunIds_52        = 201,202
Valid_52 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)), par_103 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (201, 202) GROUP BY RP.run_id) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 AS calc_value FROM cs0 B WHERE B.run_id IN (201, 202) UNION ALL SELECT B.run_id, 1201 AS calc_id, B.dim0, B.dim1, B.src1 + BP103.param_value AS calc_value FROM cs1 B INNER JOIN par_103 BP103 ON (BP103.run_id = B.run_id) WHERE B.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SQRT(SUM(((M1.acc_value + M1P103.param_value) - T2.ex1) * ((M1.acc_value + M1P103.param_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value + M1P103.param_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value + M1P103.param_value) - 1 ELSE NULL END / CASE WHEN ABS( COUNT(M1.acc_value + M1P103.param_value) ) > 1.0e-37 THEN COUNT(M1.acc_value + M1P103.param_value) ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN par_103 M1P103 ON (M1P103.run_id = M1.run_id) INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value + M2P103.param_value) AS ex1 FROM asrc M2 INNER JOIN par_103 M2P103 ON (M2P103.run_id = M2.run_id) WHERE M2.acc_id = 0 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, 100 * ( SQRT(SUM(((M1.acc_value + 100 / M1P103.param_value) - T2.ex1) * ((M1.acc_value + 100 / M1P103.param_value) - T2.ex1)) / CASE WHEN ABS( COUNT(M1.acc_value + 100 / M1P103.param_value) - 1 ) > 1.0e-37 THEN COUNT(M1.acc_value + 100 / M1P103.param_value) - 1 ELSE NULL END ) / CASE WHEN ABS( AVG(M1.acc_value + 100 / M1P103.param_value) ) > 1.0e-37 THEN AVG(M1.acc_value + 100 / M1P103.param_value) ELSE NULL END ) AS calc_value FROM asrc M1 INNER JOIN par_103 M1P103 ON (M1P103.run_id = M1.run_id) INNER JOIN (SELECT M2.run_id, M2.dim0, M2.dim1, AVG(M2.acc_value + 100 / M2P103.param_value) AS ex1 FROM asrc M2 INNER JOIN par_103 M2P103 ON (M2P103.run_id = M2.run_id) WHERE M2.acc_id = 1 GROUP BY M2.run_id, M2.dim0, M2.dim1) T2 ON (T2.run_id = M1.run_id AND T2.dim0 = M1.dim0 AND T2.dim1 = M1.dim1) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202) ORDER BY 1, 2, 3, 4

; mix of expressions, aggregation and run comparison, using parameters
;
Calculate_61     = expr0 + param.StartingSeed , expr0[variant] - expr1[base] + param.StartingSeed[base]
CalculateAggr_61 = param.StartingSeed + OM_AVG(acc0) , OM_SUM(acc1 + 100 / param.StartingSeed)
BaseRunId_61 = 201
RunIds_61    = 202,205
Valid_61 = WITH cs0 (run_id, dim0, dim1, src0) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 0), cs1 (run_id, dim0, dim1, src1) AS (SELECT BR.run_id, C.dim0, C.dim1, C.expr_value FROM salarySex_v_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101) WHERE C.expr_id = 1), asrc (run_id, acc_id, sub_id, dim0, dim1, acc_value) AS (SELECT BR.run_id, C.acc_id, C.sub_id, C.dim0, C.dim1, C.acc_value FROM salarySex_a_2012882 C INNER JOIN run_table BR ON (BR.base_run_id = C.run_id AND BR.table_hid = 101)), par_103 (run_id, param_value) AS (SELECT RP.run_id, AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id IN (201, 202, 205) GROUP BY RP.run_id), pbase_103 (param_base) AS (SELECT AVG(C.param_value) FROM StartingSeed_p_2012819 C INNER JOIN run_parameter RP ON (RP.base_run_id = C.run_id AND RP.parameter_hid = 103) WHERE RP.run_id = 201) SELECT B.run_id, 1200 AS calc_id, B.dim0, B.dim1, B.src0 + BP103.param_value AS calc_value FROM cs0 B INNER JOIN par_103 BP103 ON (BP103.run_id = B.run_id) WHERE B.run_id IN (201, 202, 205) UNION ALL SELECT V.run_id, 1201 AS calc_id, B.dim0, B.dim1, V.src0 - B.src1 + PB103.param_base AS calc_value FROM cs1 B INNER JOIN cs0 V ON (V.dim0 = B.dim0 AND V.dim1 = B.dim1) INNER JOIN pbase_103 PB103 WHERE B.run_id = 201 AND V.run_id IN (202, 205) UNION ALL SELECT A.run_id, 2400 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, M1P103.param_value + AVG(M1.acc_value) AS calc_value FROM asrc M1 INNER JOIN par_103 M1P103 ON (M1P103.run_id = M1.run_id) WHERE M1.acc_id = 0 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202, 205) UNION ALL SELECT A.run_id, 2401 AS calc_id, A.dim0, A.dim1, A.calc_value FROM ( SELECT M1.run_id, M1.dim0, M1.dim1, SUM(M1.acc_value + 100 / M1P103.param_value) AS calc_value FROM asrc M1 INNER JOIN par_103 M1P103 ON (M1P103.run_id = M1.run_id) WHERE M1.acc_id = 1 GROUP BY M1.run_id, M1.dim0, M1.dim1 ) A WHERE A.run_id IN (201, 202, 205) ORDER BY 1, 2, 3, 4



; go test -run CalculateOutputTable ./ompp/db
; go test -v -run CalculateOutputTable$ ./ompp/db
;
[CalculateOutputTable]
ModelName      = modelOne
ModelDigest    = 
DbPath         = ../../../test/modelOne.sqlite
TableName      = salarySex

Calculate_1     = expr0 , expr1
CalculateAggr_1 = OM_AVG(acc0) , OM_SUM(acc1)
RunIds_1        = 201,202,205
